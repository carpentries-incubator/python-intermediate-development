<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Intermediate Research Software Development: 3.4 Code Refactoring</title><meta name="viewport" content="width=device-width, initial-scale=1"><script src="../assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../favicons/incubator/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicons/incubator/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicons/incubator/favicon-16x16.png"><link rel="manifest" href="../favicons/incubator/site.webmanifest"><link rel="mask-icon" href="../favicons/incubator/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" media="(prefers-color-scheme: light)" content="white"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="black"></head><body>
    <header id="top" class="navbar navbar-expand-md top-nav incubator"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="incubator-logo" alt="Lesson Description" src="../assets/images/incubator-logo.svg"><span class="badge text-bg-info">
          <abbr title="This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team.">
            <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#polishing-beta-stage" class="external-link alert-link">
              <i aria-hidden="true" class="icon" data-feather="alert-circle" style="border-radius: 5px"></i>
              Beta
            </a>
            <span class="visually-hidden">This lesson is in the beta phase, which means that it is ready for teaching by instructors outside of the original author team.</span>
          </abbr>
        </span>

      </div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text"><li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul></li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../34-code-refactoring.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Lesson Description" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Intermediate Research Software Development
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Intermediate Research Software Development
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"><hr><li><a class="dropdown-item" href="quiz.html">Quiz</a></li><li><a class="dropdown-item" href="installation-instructions.html">Installation Instructions</a></li><li><a class="dropdown-item" href="common-issues.html">Common Issues, Fixes &amp; Tips</a></li><li><a class="dropdown-item" href="software-architecture-extra.html">Extra Content: Software Architecture</a></li><li><a class="dropdown-item" href="programming-paradigms.html">Extra Content: Programming Paradigms</a></li><li><a class="dropdown-item" href="procedural-programming.html">Extra Content: Procedural Programming</a></li><li><a class="dropdown-item" href="functional-programming.html">Extra Content: Functional Programming</a></li><li><a class="dropdown-item" href="object-oriented-programming.html">Extra Content: Object Oriented Programming</a></li><li><a class="dropdown-item" href="persistence.html">Extra Content: Persistence</a></li><li><a class="dropdown-item" href="databases.html">Extra Content: Databases</a></li><li><a class="dropdown-item" href="vscode.html">Extra Content: Using Microsoft Visual Studio Code</a></li><li><a class="dropdown-item" href="reference.html">Reference</a></li>
          </ul></li>
      </ul></div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="../instructor/aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Intermediate Research Software Development
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 61%" class="percentage">
    61%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 61%" aria-valuenow="61" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text"><li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul></li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../34-code-refactoring.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->

            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="00-setting-the-scene.html">Setting the Scene</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="10-section1-intro.html">Section 1: Setting Up Environment For Collaborative Code Development</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="11-software-project.html">1.1 Introduction to Our Software Project</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="12-virtual-environments.html">1.2 Virtual Environments For Software Development</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="13-ides.html">1.3 Integrated Software Development Environments</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="14-collaboration-using-git.html">1.4 Software Development Using Git and GitHub</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="15-coding-conventions.html">1.5 Python Code Style Conventions</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="16-verifying-code-style-linters.html">1.6 Verifying Code Style Using Linters</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="17-section1-optional-exercises.html">1.7 Optional Exercises</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="20-section2-intro.html">Section 2: Ensuring Correctness of Software at Scale</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="21-automatically-testing-software.html">2.1 Automatically Testing Software</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush13">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading13">
        <a href="22-scaling-up-unit-testing.html">2.2 Scaling Up Unit Testing</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush14">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading14">
        <a href="23-continuous-integration-automated-testing.html">2.3 Continuous Integration for Automated Testing</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush15">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading15">
        <a href="24-diagnosing-issues-improving-robustness.html">2.4 Diagnosing Issues and Improving Robustness</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush16">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading16">
        <a href="25-section2-optional-exercises.html">2.5 Optional Exercises for Section 2</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush17">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading17">
        <a href="30-section3-intro.html">Section 3: Software Development as a Process</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush18">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading18">
        <a href="31-software-requirements.html">3.1 Software Requirements</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush19">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading19">
        <a href="32-software-architecture-design.html">3.2 Software Architecture and Design</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush20">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading20">
        <a href="33-code-decoupling-abstractions.html">3.3 Code Decoupling &amp; Abstractions</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        3.4 Code Refactoring
        </span>
      </button>
    </div><!--/div.accordion-header-->

    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#introduction">Introduction</a></li>
<li><a href="#writing-tests-before-refactoring">Writing Tests Before Refactoring</a></li>
<li><a href="#separating-pure-and-impure-code">Separating Pure and Impure Code</a></li>
<li><a href="#programming-paradigms">Programming Paradigms</a></li>
<li><a href="#software-design-and-architecture">Software Design and Architecture</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush22">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading22">
        <a href="35-software-architecture-revisited.html">3.5 Software Architecture Revisited</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush23">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading23">
        <a href="40-section4-intro.html">Section 4: Collaborative Software Development for Reuse</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush24">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading24">
        <a href="41-code-review.html">4.1 Developing Software In a Team: Code Review</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush25">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading25">
        <a href="42-software-reuse.html">4.2 Preparing Software for Reuse and Release</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush26">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading26">
        <a href="43-software-release.html">4.3 Packaging Code for Release and Distribution</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush27">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading27">
        <a href="50-section5-intro.html">Section 5: Managing and Improving Software Over Its Lifetime</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush28">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading28">
        <a href="51-managing-software.html">5.1 Managing a Collaborative Software Project</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush29">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading29">
        <a href="52-assessing-software-suitability-improvement.html">5.2 Assessing Software for Suitability and Improvement</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush30">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading30">
        <a href="53-improvement-through-feedback.html">5.3 Software Improvement Through Feedback</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush31">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading31">
        <a href="60-wrap-up.html">Wrap-up</a>
    </div><!--/div.accordion-header-->

  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      <hr><li><a class="dropdown-item" href="quiz.html">Quiz</a></li><li><a class="dropdown-item" href="installation-instructions.html">Installation Instructions</a></li><li><a class="dropdown-item" href="common-issues.html">Common Issues, Fixes &amp; Tips</a></li><li><a class="dropdown-item" href="software-architecture-extra.html">Extra Content: Software Architecture</a></li><li><a class="dropdown-item" href="programming-paradigms.html">Extra Content: Programming Paradigms</a></li><li><a class="dropdown-item" href="procedural-programming.html">Extra Content: Procedural Programming</a></li><li><a class="dropdown-item" href="functional-programming.html">Extra Content: Functional Programming</a></li><li><a class="dropdown-item" href="object-oriented-programming.html">Extra Content: Object Oriented Programming</a></li><li><a class="dropdown-item" href="persistence.html">Extra Content: Persistence</a></li><li><a class="dropdown-item" href="databases.html">Extra Content: Databases</a></li><li><a class="dropdown-item" href="vscode.html">Extra Content: Using Microsoft Visual Studio Code</a></li><li><a class="dropdown-item" href="reference.html">Reference</a></li>
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources"><a href="../instructor/aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">

            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/33-code-decoupling-abstractions.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/35-software-architecture-revisited.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/33-code-decoupling-abstractions.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: 3.3 Code Decoupling
        </a>
        <a class="chapter-link float-end" href="../instructor/35-software-architecture-revisited.html" rel="next">
          Next: 3.5 Software...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>3.4 Code Refactoring</h1>
        <p>Last updated on 2024-12-06 |

        <a href="https://github.com/carpentries-incubator/python-intermediate-development/edit/main/episodes/34-code-refactoring.md" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>



        <p>Estimated time: <i aria-hidden="true" data-feather="clock"></i> 50 minutes</p>

        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How do you refactor existing code without breaking it?</li>
<li>What are benefits of using pure functions in code?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Employ code refactoring to improve the structure of existing
code.</li>
<li>Understand the use of regressions tests to avoid breaking existing
code when refactoring.</li>
<li>Understand the use of pure functions in software design to make the
code easier to read, test amd maintain.</li>
<li>Refactor a piece of code to separate out ‘pure’ from ‘impure’
code.</li>
</ul></div>
</div>
</div>
</div>
</div>
<section><h2 class="section-heading" id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a></h2>
<hr class="half-width"><p>Code refactoring is the process of improving the design of an
existing codebase - changing the internal structure of code without
changing its external behavior, with the goal of making the code more
readable, maintainable, efficient or easier to test. This can include
introducing things such as code decoupling and abstractions, but also
renaming variables, reorganising functions to avoid code duplication and
increase reuse, and simplifying conditional statements.</p>
<p>In the previous episode, we have already changed the structure of our
code (i.e. refactored it to a certain extent) when we separated out data
loading from data analysis but we have not tested that the new code
works as intended. This is particularly important with bigger code
changes but even a small change can easily break the codebase and
introduce bugs.</p>
<p>When faced with an existing piece of code that needs modifying a good
refactoring process to follow is:</p>
<ol style="list-style-type: decimal"><li>Make sure you have tests that verify the current behaviour</li>
<li>Refactor the code</li>
<li>Verify that that the behaviour of the code is identical to that
before refactoring.</li>
</ol><p>In this episode we will further improve the code from our project in
the following two ways:</p>
<ul><li>add more tests so we can be more confident that future changes will
have the intended effect and will not break the existing code.</li>
<li>further split <code>analyse_data()</code> function into a number of
smaller and more decoupled functions (continuing the work from the
previous episode).</li>
</ul></section><section><h2 class="section-heading" id="writing-tests-before-refactoring">Writing Tests Before Refactoring<a class="anchor" aria-label="anchor" href="#writing-tests-before-refactoring"></a></h2>
<hr class="half-width"><p>When refactoring, first we need to make sure there are tests in place
that can verify the code behaviour as it is now (or write them if they
are missing), then refactor the code and, finally, check that the
original tests still pass.</p>
<p>There is a bit of a “chicken and egg” problem here - if the
refactoring is supposed to make it easier to write tests in the future,
how can we write tests before doing the refactoring? The tricks to get
around this trap are:</p>
<ul><li>test at a higher level, with coarser accuracy, and</li>
<li>write tests that you intend to replace or remove.</li>
</ul><p>The best tests are the ones that test a single bit of functionality
rigorously. However, with our current <code>analyse_data()</code> code
that is not possible because it is a large function doing a little bit
of everything. Instead we will make minimal changes to the code to make
it a bit more testable.</p>
<p>Firstly, we will modify the function to return the data instead of
visualising it because graphs are harder to test automatically
(i.e. they need to be viewed and inspected manually in order to
determine their correctness). Next, we will make the assert statements
verify what the current outcome is, rather than check whether that is
correct or not. Such tests are meant to verify that the behaviour does
not <em>change</em> rather than checking the current behaviour is
correct (there should be another set of tests checking the correctness).
This kind of testing is called <strong>regression testing</strong> as we
are testing for regressions in existing behaviour.</p>
<p>Refactoring code is not meant to change its behaviour, but sometimes
to make it possible to verify you are not changing the important
behaviour you have to make small tweaks to the code to write the tests
at all.</p>
<div id="exercise-write-regression-tests" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise-write-regression-tests" class="callout-inner">
<h3 class="callout-title">Exercise: Write Regression Tests</h3>
<div class="callout-content">
<p>Modify the <code>analyse_data()</code> function not to plot a graph
and return the data instead. Then, add a new test file called
<code>test_compute_data.py</code> in the <code>tests</code> folder and
add a regression test to verify the current output of
<code>analyse_data()</code>. We will use this test in the remainder of
this section to verify the output <code>analyse_data()</code> is
unchanged each time we refactor or change code in the future.</p>
<p>Start from the skeleton test code below:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="kw">def</span> test_analyse_data():</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>    <span class="im">from</span> inflammation.compute_data <span class="im">import</span> analyse_data</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>    path <span class="op">=</span> Path.cwd() <span class="op">/</span> <span class="st">"../data"</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>    data_source <span class="op">=</span> CSVDataSource(path)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>    result <span class="op">=</span> analyse_data(data_source)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: add assert statement(s) to test the result value is as expected</span></span></code></pre>
</div>
<p>Use <code>assert_array_almost_equal</code> from the
<code>numpy.testing</code> library to compare arrays of floating point
numbers.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Hint </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>When determining the correct return data result to use in tests, it
may be helpful to assert the result equals some random made-up data,
observe the test fail initially and then copy and paste the correct
result into the test.</p>
</div>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>One approach we can take is to:</p>
<ul><li>comment out the visualise method on <code>analyse_data()</code>
(this will cause our test to hang waiting for the result data)</li>
<li>return the data (instead of plotting it on a graph), so we can write
assert statements on the data</li>
<li>see what the calculated result value is, and assert that it is the
same as the expected value</li>
</ul><p>Putting this together, our test may look like:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> numpy.testing <span class="im">as</span> npt</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="kw">def</span> test_analyse_data():</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="im">from</span> inflammation.compute_data <span class="im">import</span> analyse_data</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>    path <span class="op">=</span> Path.cwd() <span class="op">/</span> <span class="st">"../data"</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>    data_source <span class="op">=</span> CSVDataSource(path)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>    result <span class="op">=</span> analyse_data(data_source)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>    expected_output <span class="op">=</span> [<span class="fl">0.</span>,<span class="fl">0.22510286</span>,<span class="fl">0.18157299</span>,<span class="fl">0.1264423</span>,<span class="fl">0.9495481</span>,<span class="fl">0.27118211</span>,</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>                       <span class="fl">0.25104719</span>,<span class="fl">0.22330897</span>,<span class="fl">0.89680503</span>,<span class="fl">0.21573875</span>,<span class="fl">1.24235548</span>,<span class="fl">0.63042094</span>,</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>                       <span class="fl">1.57511696</span>,<span class="fl">2.18850242</span>,<span class="fl">0.3729574</span>,<span class="fl">0.69395538</span>,<span class="fl">2.52365162</span>,<span class="fl">0.3179312</span>,</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>                       <span class="fl">1.22850657</span>,<span class="fl">1.63149639</span>,<span class="fl">2.45861227</span>,<span class="fl">1.55556052</span>,<span class="fl">2.8214853</span>,<span class="fl">0.92117578</span>,</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>                       <span class="fl">0.76176979</span>,<span class="fl">2.18346188</span>,<span class="fl">0.55368435</span>,<span class="fl">1.78441632</span>,<span class="fl">0.26549221</span>,<span class="fl">1.43938417</span>,</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>                       <span class="fl">0.78959769</span>,<span class="fl">0.64913879</span>,<span class="fl">1.16078544</span>,<span class="fl">0.42417995</span>,<span class="fl">0.36019114</span>,<span class="fl">0.80801707</span>,</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>                       <span class="fl">0.50323031</span>,<span class="fl">0.47574665</span>,<span class="fl">0.45197398</span>,<span class="fl">0.22070227</span>]</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>    npt.assert_array_almost_equal(result, expected_output)</span></code></pre>
</div>
<p>Note that while the above test will detect if we accidentally break
the analysis code and change the output of the analysis, it is still not
a complete test for the following reasons:</p>
<ul><li>It is not obvious why the <code>expected_output</code> is
correct</li>
<li>It does not test edge cases</li>
<li>If the data files in the directory change - the test will fail</li>
</ul><p>We would need to add additional tests to check the above.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="separating-pure-and-impure-code">Separating Pure and Impure Code<a class="anchor" aria-label="anchor" href="#separating-pure-and-impure-code"></a></h2>
<hr class="half-width"><p>Now that we have our regression test for <code>analyse_data()</code>
in place, we are ready to refactor the function further. We would like
to separate out as much of its code as possible as <em>pure
functions</em>.</p>
<div class="section level3">
<h3 id="pure-functions">Pure Functions<a class="anchor" aria-label="anchor" href="#pure-functions"></a></h3>
<p>A pure function in programming works like a mathematical function -
it takes in some input and produces an output and that output is always
the same for the same input. That is, the output of a pure function does
not depend on any information which is not present in the input (such as
global variables). Furthermore, pure functions do not cause any <em>side
effects</em> - they do not modify the input data or data that exist
outside the function (such as printing text, writing to a file or
changing a global variable). They perform actions that affect nothing
but the value they return.</p>
</div>
<div class="section level3">
<h3 id="benefits-of-pure-functions">Benefits of Pure Functions<a class="anchor" aria-label="anchor" href="#benefits-of-pure-functions"></a></h3>
<p>Pure functions are easier to understand because they eliminate side
effects. The reader only needs to concern themselves with the input
parameters of the function and the function code itself, rather than the
overall context the function is operating in. Similarly, a function that
calls a pure function is also easier to understand - we only need to
understand what the function returns, which will probably be clear from
the context in which the function is called. Finally, pure functions are
easier to reuse as the caller only needs to understand what parameters
to provide, rather than anything else that might need to be configured
prior to the call. For these reasons, you should try and have as much of
the complex, analytical and mathematical code are pure functions.</p>
<p>Some parts of a program are inevitably impure. Programs need to read
input from users, generate a graph, or write results to a file or a
database. Well designed programs separate complex logic from the
necessary impure “glue” code that interacts with users and other
systems. This way, you have easy-to-read and easy-to-test pure code that
contains the complex logic and simplified impure code that reads data
from a file or gathers user input. Impure code may be harder to test
but, when simplified like this, may only require a handful of tests
anyway.</p>
<div id="exercise-refactoring-to-use-a-pure-function" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise-refactoring-to-use-a-pure-function" class="callout-inner">
<h3 class="callout-title">Exercise: Refactoring To Use a Pure Function</h3>
<div class="callout-content">
<p>Refactor the <code>analyse_data()</code> function to delegate the
data analysis to a new pure function
<code>compute_standard_deviation_by_day()</code> and separate it from
the impure code that handles the input and output. The pure function
should take in the data, and return the analysis result, as follows:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="kw">def</span> compute_standard_deviation_by_day(data):</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="cf">return</span> daily_standard_deviation</span></code></pre>
</div>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Show me the solution </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>The analysis code will be refactored into a separate function that
may look something like:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">def</span> compute_standard_deviation_by_day(data):</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    means_by_day <span class="op">=</span> <span class="bu">map</span>(models.daily_mean, data)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    means_by_day_matrix <span class="op">=</span> np.stack(<span class="bu">list</span>(means_by_day))</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    daily_standard_deviation <span class="op">=</span> np.std(means_by_day_matrix, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    <span class="cf">return</span> daily_standard_deviation</span></code></pre>
</div>
<p>The <code>analyse_data()</code> function now calls the
<code>compute_standard_deviation_by_day()</code> function, while keeping
all the logic for reading the data, processing it and showing it in a
graph:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">def</span> analyse_data(data_dir):</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    <span class="co">"""Calculates the standard deviation by day between datasets.</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">    Gets all the inflammation data from CSV files within a directory, works out the mean</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">    inflammation value for each day across all datasets, then visualises the</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">    standard deviation of these means on a graph."""</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    data_file_paths <span class="op">=</span> glob.glob(os.path.join(data_dir, <span class="st">'inflammation*.csv'</span>))</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(data_file_paths) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"No inflammation csv's found in path </span><span class="sc">{</span>data_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    data <span class="op">=</span> <span class="bu">map</span>(models.load_csv, data_file_paths)</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>    daily_standard_deviation <span class="op">=</span> compute_standard_deviation_by_day(data)</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    graph_data <span class="op">=</span> {</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>        <span class="st">'standard deviation by day'</span>: daily_standard_deviation,</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>    }</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>    <span class="co"># views.visualize(graph_data)</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>    <span class="cf">return</span> daily_standard_deviation</span></code></pre>
</div>
<p>Make sure to re-run the regression test to check this refactoring has
not changed the output of <code>analyse_data()</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="testing-pure-functions">Testing Pure Functions<a class="anchor" aria-label="anchor" href="#testing-pure-functions"></a></h3>
<p>Now we have our analysis implemented as a pure function, we can write
tests that cover all the things we would like to check without depending
on CSVs files. This is another advantage of pure functions - they are
very well suited to automated testing, i.e. their tests are:</p>
<ul><li>
<strong>easier to write</strong> - we construct input and assert the
output without having to think about making sure the global state is
correct before or after</li>
<li>
<strong>easier to read</strong> - the reader will not have to open a
CSV file to understand why the test is correct</li>
<li>
<strong>easier to maintain</strong> - if at some point the data
format changes from CSV to JSON, the bulk of the tests need not be
updated</li>
</ul><div id="exercise-testing-a-pure-function" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise-testing-a-pure-function" class="callout-inner">
<h3 class="callout-title">Exercise: Testing a Pure Function</h3>
<div class="callout-content">
<p>Add tests for <code>compute_standard_deviation_by_data()</code> that
check for situations when there is only one file with multiple rows,
multiple files with one row, and any other cases you can think of that
should be tested.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Show me the solution </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<p>You might have thought of more tests, but we can easily extend the
test by parametrizing with more inputs and expected outputs:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">PYTHON<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode python" tabindex="0"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="at">@pytest.mark.parametrize</span>(<span class="st">'data,expected_output'</span>, [</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>    ([[[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">0</span>]]], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>]),</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    ([[[<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">0</span>]], [[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>]]], [<span class="dv">0</span>, math.sqrt(<span class="fl">0.25</span>), <span class="dv">0</span>]),</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    ([[[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">0</span>]], [[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>], [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">0</span>]]], [<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>])</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>],</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>ids<span class="op">=</span>[<span class="st">'Two patients in same file'</span>, <span class="st">'Two patients in different files'</span>, <span class="st">'Two identical patients in two different files'</span>])</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="kw">def</span> test_compute_standard_deviation_by_day(data, expected_output):</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>    <span class="im">from</span> inflammation.compute_data <span class="im">import</span> compute_standard_deviation_by_data</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>    result <span class="op">=</span> compute_standard_deviation_by_data(data)</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    npt.assert_array_almost_equal(result, expected_output)</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="functional-programming" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="functional-programming" class="callout-inner">
<h3 class="callout-title">Functional Programming</h3>
<div class="callout-content">
<p><strong>Functional programming</strong> is a programming paradigm
where programs are constructed by applying and composing/chaining pure
functions. Some programming languages, such as Haskell or Lisp, support
writing pure functional code only. Other languages, such as Python,
Java, C++, allow mixing <strong>functional</strong> and
<strong>procedural</strong> programming paradigms. Read more in the <a href="functional-programming.html">extra episode on functional
programming</a> and when it can be very useful to switch to this
paradigm (e.g. to employ MapReduce approach for data processing).</p>
</div>
</div>
</div>
<p>There are no definite rules in software design but making your
complex logic out of composed pure functions is a great place to start
when trying to make your code readable, testable and maintainable. This
is particularly useful for:</p>
<ul><li>Data processing and analysis (for example, using <a href="https://pandas.pydata.org/" class="external-link">Python Pandas library</a> for data
manipulation where most of functions appear pure)</li>
<li>Doing simulations (? needs more explanation)</li>
<li>Translating data from one format to another (? an example would be
good)</li>
</ul></div>
</section><section><h2 class="section-heading" id="programming-paradigms">Programming Paradigms<a class="anchor" aria-label="anchor" href="#programming-paradigms"></a></h2>
<hr class="half-width"><p>Until this section, we have mainly been writing procedural code. In
the previous episode, we have touched a bit upon classes, encapsulation
and polymorphism, which are characteristics of (but not limited to) the
object-oriented programming (OOP). In this episode, we mentioned <a href="./index.html#pure-functions">pure functions</a> and Functional
Programming.</p>
<p>These are examples of different <a href="programming-paradigms.html">programming paradigms</a> and provide
varied approaches to structuring your code - each with certain strengths
and weaknesses when used to solve particular types of problems. In many
cases, particularly with modern languages, a single language can allow
many different structural approaches and mixing programming paradigms
within your code. Once your software begins to get more complex - it is
common to use aspects of <a href="programming-paradigms.html">different
paradigm</a> to handle different subtasks. Because of this, it is useful
to know about the <a href="programming-paradigms.html">major
paradigms</a>, so you can recognise where it might be useful to switch.
This is outside of scope of this course - we have some extra episodes on
the topics of <a href="procedural-programming.html">procedural
programming</a>, <a href="functional-programming.html">functional
programming</a> and <a href="object-oriented-programming.html">object-oriented programming</a>
if you want to know more.</p>
<div id="so-which-one-is-python" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="so-which-one-is-python" class="callout-inner">
<h3 class="callout-title">So Which One is Python?</h3>
<div class="callout-content">
<p>Python is a multi-paradigm and multi-purpose programming language.
You can use it as a procedural language and you can use it in a more
object oriented way. It does tend to land more on the object oriented
side as all its core data types (strings, integers, floats, booleans,
lists, sets, arrays, tuples, dictionaries, files) as well as functions,
modules and classes are objects.</p>
<p>Since functions in Python are also objects that can be passed around
like any other object, Python is also well suited to functional
programming. One of the most popular Python libraries for data
manipulation, <a href="https://pandas.pydata.org/" class="external-link">Pandas</a> (built on
top of NumPy), supports a functional programming style as most of its
functions on data are not changing the data (no side effects) but
producing a new data to reflect the result of the function.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="software-design-and-architecture">Software Design and Architecture<a class="anchor" aria-label="anchor" href="#software-design-and-architecture"></a></h2>
<hr class="half-width"><p>In this section so far we have been talking about <strong>software
design</strong> - the individual modules and components of the software.
We are now going to have a brief look into <strong>software
architecture</strong> - which is about the overall structure that these
software components fit into, a <em>design pattern</em> with a common
successful use of software components.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul><li>Code refactoring is a technique for improving the structure of
existing code.</li>
<li>Implementing regression tests before refactoring gives you
confidence that your changes have not broken the code.</li>
<li>Using pure functions that process data without side effects whenever
possible makes the code easier to understand, test and maintain.</li>
</ul></div>
</div>
</div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/33-code-decoupling-abstractions.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/35-software-architecture-revisited.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/33-code-decoupling-abstractions.html" rel="prev">
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>
          Previous: 3.3 Code Decoupling
        </a>
        <a class="chapter-link float-end" href="../instructor/35-software-architecture-revisited.html" rel="next">
          Next: 3.5 Software...
          <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i>
        </a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/carpentries-incubator/python-intermediate-development/edit/main/episodes/34-code-refactoring.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/carpentries-incubator/python-intermediate-development/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/carpentries-incubator/python-intermediate-development/" class="external-link">Source</a></p>
				<p><a href="https://github.com/carpentries-incubator/python-intermediate-development/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:info@software.ac.uk">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.11" class="external-link">sandpaper (0.16.11)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.5" class="external-link">varnish (1.0.5)</a></p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://carpentries-incubator.github.io/python-intermediate-development/instructor/34-code-refactoring.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "3.4 Code Refactoring",
  "creativeWorkStatus": "active",
  "url": "https://carpentries-incubator.github.io/python-intermediate-development/instructor/34-code-refactoring.html",
  "identifier": "https://carpentries-incubator.github.io/python-intermediate-development/instructor/34-code-refactoring.html",
  "dateCreated": "2020-04-23",
  "dateModified": "2024-12-06",
  "datePublished": "2025-04-29"
}

  </script><script>
		feather.replace();
	</script></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

